@using Microsoft.AspNetCore.Mvc.Rendering
@model HotelManagement.Models.DatPhongRequest
@{
    ViewData["Title"] = "Đặt phòng mới";

    // Model is initialized in controller, but ensure safe access
    var chiTietDatPhongs = Model.ChiTietDatPhongs ?? new List<HotelManagement.Models.ChiTietDatPhongRequest>();
    var suDungDichVus = Model.SuDungDichVus ?? new List<HotelManagement.Models.SuDungDichVuRequest>();

    // ✅ ViewBag null-safe
    var phongOptions = (ViewBag.PhongOptions.Items as IEnumerable<HotelManagement.Models.Phong>)
        ?? Enumerable.Empty<HotelManagement.Models.Phong>();
    var dichVuOptions = (ViewBag.DichVuOptions.Items as IEnumerable<HotelManagement.Models.DichVu>)
        ?? Enumerable.Empty<HotelManagement.Models.DichVu>();
    var loaiPhongOptions = (ViewBag.LoaiPhongOptions.Items as IEnumerable<HotelManagement.Models.LoaiPhong>)
            ?? Enumerable.Empty<HotelManagement.Models.LoaiPhong>();

    // Build select lists
    var phongSelectList = phongOptions
        .Select(p => new SelectListItem
                {
                    Value = p.Id.ToString(),
                    Text = $"{p.SoPhong} - {p.LoaiPhong?.TenLoaiPhong ?? "N/A"} ({(p.LoaiPhong?.GiaMoiDem ?? 0).ToString("N0")} đ/đêm)"
                })
        .ToList();

    var dichVuSelectList = dichVuOptions
        .Select(d => new SelectListItem
                {
                    Value = d.maDichVu.ToString(),
                    Text = $"{d.TenDichVu} ({d.donGia.ToString("N0")} đ)"
                })
        .ToList();

    var khachHangOptions = (ViewBag.KhachHangList.Items as IEnumerable<HotelManagement.Models.KhachHang>)
      ?? Enumerable.Empty<HotelManagement.Models.KhachHang>();

    var khachHangList = khachHangOptions
        .Select(kh => new SelectListItem
                {
                    Value = kh.maKhachHang.ToString(),
                    Text = $"{kh.hoTen} - {kh.SoDienThoai ?? "N/A"}"
                })
        .ToList();

    var nhanVienOptions = (ViewBag.NhanVienList.Items as IEnumerable<HotelManagement.Models.NhanVien>)
        ?? Enumerable.Empty<HotelManagement.Models.NhanVien>();

    var nhanVienList = nhanVienOptions
        .Select(nv => new SelectListItem
                {
                    Value = nv.Id.ToString(),
                    Text = $"{nv.HoTen} - {nv.ChucVu ?? "N/A"}"
                })
        .ToList();

    var loaiPhongSelectList = loaiPhongOptions
          .Select(d => new SelectListItem
          {
              Value = d.MaLoaiPhong.ToString(),
              Text = $"{d.TenLoaiPhong}"
          })
          .ToList();
}

<h2 class="mb-4">@ViewData["Title"]</h2>

<form asp-action="Create" id="createForm" method="post" class="needs-validation" novalidate>
    <partial name="_ValidationSummary" />

    <div class="row g-3">
        <div class="col-md-6">
            <label asp-for="MaKhachHang" class="form-label">Khách hàng</label>
            <select asp-for="MaKhachHang" asp-items="khachHangList" class="form-select"></select>
            <span asp-validation-for="MaKhachHang" class="text-danger"></span>
        </div>
        <div class="col-md-6">
            <label asp-for="MaNhanVien" class="form-label">Nhân viên phụ trách</label>
            <select asp-for="MaNhanVien" asp-items="nhanVienList" class="form-select"></select>
            <span asp-validation-for="MaNhanVien" class="text-danger"></span>
        </div>
        <div class="col-md-4">
            <label asp-for="NgayDat" class="form-label">Ngày đặt</label>
            <input asp-for="NgayDat" class="form-control" type="date" />
            <span asp-validation-for="NgayDat" class="text-danger"></span>
        </div>
        <div class="col-md-4">
            <label asp-for="NgayNhan" class="form-label">Ngày nhận</label>
            <input asp-for="NgayNhan" class="form-control" type="date" />
            <span asp-validation-for="NgayNhan" class="text-danger"></span>
        </div>
        <div class="col-md-4">
            <label asp-for="NgayTra" class="form-label">Ngày trả</label>
            <input asp-for="NgayTra" class="form-control" type="date" />
            <span asp-validation-for="NgayTra" class="text-danger"></span>
        </div>
        <div class="col-md-4">
            <label asp-for="TrangThai" class="form-label">Trạng thái</label>
            <select asp-for="TrangThai" class="form-select">
                <option value="">-- Chọn trạng thái --</option>
                <option value="Đã đặt">Đã đặt</option>
                <option value="Đã nhận">Đã nhận</option>
                <option value="Đã trả">Đã trả</option>
                <option value="Hủy">"Hủy</option>
            </select>
            <span asp-validation-for="TrangThai" class="text-danger"></span>
        </div>
    </div>

    <hr class="my-4" />


    <h5 class="mb-3">Chi tiết phòng</h5>
    <div class="table-responsive mb-3">
        <table class="table align-middle">
            <thead class="table-light">
                <tr>
                    <th style="width: 30%">Phòng</th>
                    <th style="width: 20%">Đơn giá</th>
                    <th style="width: 15%">Số đêm</th>
                    <th style="width: 25%">Tổng tiền</th>
                    <th style="width: 10%">Thao tác</th>
                </tr>
            </thead>
            <tbody id="phongContainer">
                <!-- Dynamic rows will be added here by JavaScript -->
            </tbody>
        </table>
        <button type="button" id="addPhongBtn" class="btn btn-outline-primary btn-sm">
            <i class="fas fa-plus"></i> Thêm phòng
        </button>
    </div>

    <h5 class="mb-3">Dịch vụ sử dụng</h5>
    <div class="table-responsive mb-3">
        <table class="table align-middle">
            <thead class="table-light">
                <tr>
                    <th style="width: 30%">Dịch vụ</th>
                    <th style="width: 15%">Số lượng</th>
                    <th style="width: 20%">Đơn giá</th>
                    <th style="width: 25%">Tổng tiền</th>
                    <th style="width: 10%">Thao tác</th>
                </tr>
            </thead>
            <tbody id="dichVuContainer">
                <!-- Dynamic rows will be added here by JavaScript -->
            </tbody>
        </table>
        <button type="button" id="addDichVuBtn" class="btn btn-outline-primary btn-sm">
            <i class="fas fa-plus"></i> Thêm dịch vụ
        </button>
    </div>

    <div class="alert alert-info">
        <div class="d-flex justify-content-between">
            <span class="fw-semibold">Tổng tiền dịch vụ tạm tính</span>
            <span id="tongTienDichVu">@(suDungDichVus.Sum(s => s.ThanhTien).ToString("N0")) đ</span>
        </div>
        <div class="d-flex justify-content-between">
            <span class="fw-semibold">Tổng tiền phòng tạm tính</span>
            <span id="tongTienPhong">@(chiTietDatPhongs.Sum(ct => ct.ThanhTien).ToString("N0")) đ</span>
        </div>
        <div class="d-flex justify-content-between">
            <span class="fw-semibold">Tổng cộng</span>
            <span id="tongCong">@((chiTietDatPhongs.Sum(ct => ct.ThanhTien) + suDungDichVus.Sum(s => s.ThanhTien)).ToString("N0")) đ</span>
        </div>
    </div>

    <partial name="_FormActions" />
</form>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        // Pass ViewBag data to JavaScript
        window.DatPhongData = {
            phongOptions: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(phongOptions)),
            dichVuOptions: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(dichVuOptions)),
            loaiPhongOptions: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(loaiPhongOptions))
        };
    </script>
    <script src="~/js/datPhong.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            DatPhongApp.initCreateForm();
        });
    </script>
}