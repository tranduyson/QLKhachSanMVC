@using Microsoft.AspNetCore.Mvc.Rendering
@model HotelManagement.Models.DatPhong
@{
    ViewData["Title"] = "Chỉnh sửa đặt phòng";

    // Model is initialized in controller, but ensure safe access
    var chiTietDatPhongs = Model.chiTietDatPhongs ?? new List<HotelManagement.Models.ChiTietDatPhong>();
    var suDungDichVus = Model.suDungDichVus ?? new List<HotelManagement.Models.SuDungDichVu>();

    // Ensure at least one element
    if (chiTietDatPhongs.Count == 0)
    {
        chiTietDatPhongs.Add(new HotelManagement.Models.ChiTietDatPhong
        {
            SoPhong = string.Empty,
            TenLoaiPhong = string.Empty
        });
    }
    if (suDungDichVus.Count == 0)
    {
        suDungDichVus.Add(new HotelManagement.Models.SuDungDichVu
        {
            TenDichVu = string.Empty
        });
    }

    // ViewBag null-safe
    var phongOptions = (ViewBag.PhongOptions as IEnumerable<HotelManagement.Models.Phong>)
        ?? Enumerable.Empty<HotelManagement.Models.Phong>();
    var dichVuOptions = (ViewBag.DichVuOptions as IEnumerable<HotelManagement.Models.DichVu>)
        ?? Enumerable.Empty<HotelManagement.Models.DichVu>();

    // Build select lists
    var phongSelectList = phongOptions
        .Select(p => new SelectListItem
        {
            Value = p.Id.ToString(),
            Text = $"{p.SoPhong} - {p.LoaiPhong?.TenLoaiPhong ?? "N/A"} ({(p.LoaiPhong?.GiaMoiDem ?? 0).ToString("N0")} đ/đêm)"
        })
        .ToList();

    var dichVuSelectList = dichVuOptions
        .Select(d => new SelectListItem
        {
            Value = d.maDichVu.ToString(),
            Text = $"{d.TenDichVu} ({d.donGia.ToString("N0")} đ)"
        })
        .ToList();

    var khachHangList = (ViewBag.KhachHangList as IEnumerable<SelectListItem>)
        ?? Enumerable.Empty<SelectListItem>();
    var nhanVienList = (ViewBag.NhanVienList as IEnumerable<SelectListItem>)
        ?? Enumerable.Empty<SelectListItem>();
    var trangThaiList = (ViewBag.TrangThaiList as IEnumerable<SelectListItem>)
        ?? Enumerable.Empty<SelectListItem>();
}

<h2 class="mb-4">@ViewData["Title"]</h2>

<form asp-action="Edit" method="post" class="needs-validation" novalidate>
    <input type="hidden" asp-for="maDatPhong" />
    <partial name="_ValidationSummary" />

    <div class="row g-3">
        <div class="col-md-6">
            <label asp-for="maKhachHang" class="form-label">Khách hàng</label>
            <select asp-for="maKhachHang" asp-items="khachHangList" class="form-select"></select>
            <span asp-validation-for="maKhachHang" class="text-danger"></span>
        </div>
        <div class="col-md-6">
            <label asp-for="maNhanVien" class="form-label">Nhân viên phụ trách</label>
            <select asp-for="maNhanVien" asp-items="nhanVienList" class="form-select"></select>
            <span asp-validation-for="maNhanVien" class="text-danger"></span>
        </div>
        <div class="col-md-4">
            <label asp-for="ngayDat" class="form-label">Ngày đặt</label>
            <input asp-for="ngayDat" class="form-control" type="date" />
            <span asp-validation-for="ngayDat" class="text-danger"></span>
        </div>
        <div class="col-md-4">
            <label asp-for="ngayNhan" class="form-label">Ngày nhận</label>
            <input asp-for="ngayNhan" class="form-control" type="date" />
            <span asp-validation-for="ngayNhan" class="text-danger"></span>
        </div>
        <div class="col-md-4">
            <label asp-for="ngayTra" class="form-label">Ngày trả</label>
            <input asp-for="ngayTra" class="form-control" type="date" />
            <span asp-validation-for="ngayTra" class="text-danger"></span>
        </div>
        <div class="col-md-4">
            <label asp-for="trangThai" class="form-label">Trạng thái</label>
            <select asp-for="trangThai" asp-items="trangThaiList" class="form-select"></select>
            <span asp-validation-for="trangThai" class="text-danger"></span>
        </div>
    </div>

    <hr class="my-4" />

    <h5 class="mb-3">Chi tiết phòng</h5>
    <div id="phongContainer">
        @for (int i = 0; i < chiTietDatPhongs.Count; i++)
        {
            <div class="dynamic-row">
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Phòng <span class="text-danger">*</span></label>
                            <select class="form-select phong-select" name="chiTietDatPhongs[@i].phongId" required>
                                <option value="">Chọn phòng...</option>
                                @foreach (var phong in phongOptions.Where(p => p.TinhTrang == "Trong" || p.Id == chiTietDatPhongs[i].PhongId))
                                {
                                    <option value="@phong.Id" selected="@(phong.Id == chiTietDatPhongs[i].PhongId ? "selected" : null)">
                                        @phong.SoPhong - @phong.LoaiPhong?.TenLoaiPhong (@(phong.LoaiPhong?.GiaMoiDem ?? 0).ToString("N0") đ/đêm)
                                    </option>
                                }
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">Đơn giá (VNĐ) <span class="text-danger">*</span></label>
                            <input type="number" class="form-control don-gia" name="chiTietDatPhongs[@i].donGia" value="@chiTietDatPhongs[i].DonGia" min="0" step="1000" required>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">Số đêm <span class="text-danger">*</span></label>
                            <input type="number" class="form-control so-dem" name="chiTietDatPhongs[@i].soDem" value="@chiTietDatPhongs[i].SoDem" min="1" required>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="mb-3">
                            <label class="form-label">&nbsp;</label>
                            <button type="button" class="btn btn-danger btn-sm w-100 remove-phong">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
    <button type="button" id="addPhongBtn" class="btn btn-outline-primary btn-sm mb-3">
        <i class="fas fa-plus"></i> Thêm phòng
    </button>

    <h5 class="mb-3">Dịch vụ sử dụng</h5>
    <div id="dichVuContainer">
        @for (int i = 0; i < suDungDichVus.Count; i++)
        {
            <div class="dynamic-row">
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Dịch vụ</label>
                            <select class="form-select dichvu-select" name="suDungDichVus[@i].dichVuId">
                                <option value="">Chọn dịch vụ...</option>
                                @foreach (var dichVu in dichVuOptions)
                                {
                                    <option value="@dichVu.maDichVu" selected="@(dichVu.maDichVu == suDungDichVus[i].DichVuId ? "selected" : null)">
                                        @dichVu.TenDichVu (@dichVu.donGia.ToString("N0") đ)
                                    </option>
                                }
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">Số lượng</label>
                            <input type="number" class="form-control so-luong" name="suDungDichVus[@i].soLuong" value="@suDungDichVus[i].SoLuong" min="1" value="1">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">Đơn giá (VNĐ)</label>
                            <input type="number" class="form-control don-gia-dichvu" name="suDungDichVus[@i].donGia" value="@suDungDichVus[i].DonGia" min="0" step="1000">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="mb-3">
                            <label class="form-label">&nbsp;</label>
                            <button type="button" class="btn btn-danger btn-sm w-100 remove-dichvu">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
    <button type="button" id="addDichVuBtn" class="btn btn-outline-primary btn-sm mb-3">
        <i class="fas fa-plus"></i> Thêm dịch vụ
    </button>

    <div class="alert alert-info">
        <div class="d-flex justify-content-between">
            <span class="fw-semibold">Tổng tiền dịch vụ tạm tính</span>
            <span id="tongTienDichVu">@(suDungDichVus.Sum(s => s.ThanhTien).ToString("N0")) đ</span>
        </div>
        <div class="d-flex justify-content-between">
            <span class="fw-semibold">Tổng tiền phòng tạm tính</span>
            <span id="tongTienPhong">@(chiTietDatPhongs.Sum(ct => ct.ThanhTien).ToString("N0")) đ</span>
        </div>
        <div class="d-flex justify-content-between">
            <span class="fw-semibold">Tổng cộng</span>
            <span id="tongCong">@((chiTietDatPhongs.Sum(ct => ct.ThanhTien) + suDungDichVus.Sum(s => s.ThanhTien)).ToString("N0")) đ</span>
        </div>
    </div>

    <partial name="_FormActions" />
</form>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        // Pass ViewBag data to JavaScript
        window.DatPhongData = {
            phongOptions: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(phongOptions)),
            dichVuOptions: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(dichVuOptions))
        };
    </script>
    <script src="~/js/datPhong.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            DatPhongApp.initCreateForm();
        });
    </script>
}